# 

import requests
import psycopg2

# Connect to PostgreSQL
conn = psycopg2.connect(
    dbname="eve_data",
    user="postgres",
    password="109009885",  # replace this
    host="localhost",
    port="5432"
)
cur = conn.cursor()

# Step 1: Get unique type_ids from the database
cur.execute("SELECT DISTINCT type_id FROM forge_orders;")
type_ids = [row[0] for row in cur.fetchall()]

# Step 2: Look up type names from ESI API in batches of 1000
url = "https://esi.evetech.net/latest/universe/names/"
batch_size = 1000
inv_types = []

for i in range(0, len(type_ids), batch_size):
    batch = type_ids[i:i + batch_size]
    response = requests.post(url, json=batch)
    if response.status_code == 200:
        data = response.json()
        for entry in data:
            if entry["category"] == "inventory_type":
                inv_types.append((entry["id"], entry["name"]))

# Step 3: Create the inv_types table (if not exists)
cur.execute("""
    CREATE TABLE IF NOT EXISTS inv_types (
        type_id INT PRIMARY KEY,
        type_name TEXT
    );
""")

# Step 4: Insert data
for type_id, type_name in inv_types:
    cur.execute("""
        INSERT INTO inv_types (type_id, type_name)
        VALUES (%s, %s)
        ON CONFLICT (type_id) DO NOTHING;
    """, (type_id, type_name))

conn.commit()
cur.close()
conn.close()

print(f"Inserted {len(inv_types)} item names into inv_types table.")
